# ADR-008 — Normalized Help Model Specification

**Status:** Accepted
**Date:** 2026-02-20

---

## Context

The suite must support multiple input sources:

* Comment-based help in scripts/modules
* Compiled cmdlets via reflection + XML documentation
* Existing MAML files
* HelpInfo.xml metadata

To guarantee consistent output and keep generator logic simple, we need one canonical internal representation for:

* Module metadata
* Command help content
* Parameter sets and parameter metadata
* Examples, inputs/outputs, and related links
* Localization/culture support

This ADR defines the **normalized help model** used across the entire suite.

---

## Decision

We define a single internal object graph (the “Normalized Help Model”) with these top-level entities:

1. `HelpPackage` (root)
2. `ModuleHelp` (module metadata + updatable help metadata)
3. `CommandHelp` (per-command content)
4. `ParameterHelp` (per-parameter metadata + prose)
5. `ParameterSetHelp` (syntax grouping)
6. `ExampleHelp`
7. `TypeHelp` (input/output types)
8. `LinkHelp` (related links)
9. `Localization` (culture-aware values)

All parsers must produce this model. All generators must consume this model.

---

## 1. Root Entity: `HelpPackage`

Represents one module’s help content (optionally multi-culture).

Required fields:

* `Module`: `ModuleHelp` (required)
* `Commands`: `List<CommandHelp>` (required; can be empty)
* `AboutTopics`: `List<AboutTopicHelp>` (optional; future-friendly)
* `Cultures`: `List<string>` (required; default: `["en-US"]`)

Rules:

* `Commands` is sorted/stabilized by `CommandHelp.Name` for output determinism.
* `Cultures` must align with HelpInfo.xml supported cultures.

---

## 2. Module Entity: `ModuleHelp`

Required fields:

* `Name`: string (module name)
* `Guid`: string (module GUID; required for updatable help)
* `Version`: string (semantic version string)
* `Description`: LocalizedText (optional; module overview)
* `Author`: string (optional)
* `CompanyName`: string (optional)
* `Copyright`: string (optional)

Updatable help metadata (for HelpInfo.xml generation):

* `HelpContentUri`: string (required when generating HelpInfo.xml for updatable help)
* `SupportedCultures`: `List<CultureHelpInfo>` (required; at least one)

  * Each culture entry includes:

    * `Culture`: string (`en-US`)
    * `HelpVersion`: string (version of help payload for that culture)
    * `CabPath` / `CabName` (optional, derived during packaging)

Rules:

* Module `Guid` must be stable across releases.
* `HelpVersion` must be independently bumpable from `ModuleHelp.Version`.

---

## 3. Localized Text: `LocalizedText`

Many text fields must support localization.

Representation:

* `Dictionary<string, string>` keyed by culture (e.g., `en-US`)
* Convenience: `Get(culture)` with fallback to default culture

Rules:

* Default culture is `en-US` unless otherwise configured.
* If a culture is missing a value, fallback to default culture for generation (with warning).

---

## 4. Command Entity: `CommandHelp`

Required fields:

* `Name`: string (`Verb-Noun`)
* `Verb`: string
* `Noun`: string

Prose fields:

* `Synopsis`: LocalizedText (required; placeholder allowed)
* `Description`: LocalizedText (optional but recommended)
* `Notes`: LocalizedText (optional)

Structural fields:

* `Parameters`: `List<ParameterHelp>` (required; may be empty)
* `ParameterSets`: `List<ParameterSetHelp>` (required; at least one)
* `Examples`: `List<ExampleHelp>` (optional)
* `Inputs`: `List<TypeHelp>` (optional)
* `Outputs`: `List<TypeHelp>` (optional)
* `Links`: `List<LinkHelp>` (optional)
* `Aliases`: `List<string>` (optional)

Rules:

* `ParameterSets` must include a “default” set if the source does not define sets.
* `Parameters` are unique by name (case-insensitive).
* `Verb`/`Noun` must match `Name` split unless command name is atypical (still stored explicitly).

---

## 5. Parameter Entity: `ParameterHelp`

Required fields:

* `Name`: string
* `TypeName`: string (e.g., `System.String`)
* `Description`: LocalizedText (required; placeholder allowed)

Metadata fields:

* `IsMandatory`: bool (default false)
* `Position`: int? (null if named-only)
* `AcceptsPipelineInput`: enum `{ None, ByValue, ByPropertyName, Both }`
* `AcceptsWildcardCharacters`: bool? (optional)
* `IsSwitch`: bool (default false)
* `DefaultValue`: string? (optional; preserved as text)
* `Aliases`: `List<string>` (optional)
* `ParameterSets`: `List<string>` (names of sets this parameter participates in; optional)
* `ValidateSet`: `List<string>` (optional)
* `ValidateRange`: `{ Min: string?, Max: string? }` (optional; stored as text)
* `AllowNull`: bool? (optional)
* `AllowEmptyString`: bool? (optional)
* `AllowEmptyCollection`: bool? (optional)

Rules:

* If `IsSwitch` is true, `TypeName` should still be recorded (e.g., `System.Management.Automation.SwitchParameter`) but generators may render it specially.
* Validation metadata is preserved but not invented.

---

## 6. Parameter Set Entity: `ParameterSetHelp`

Required fields:

* `Name`: string
* `IsDefault`: bool
* `Syntax`: `List<SyntaxParameterRef>` (required; may be empty)

`SyntaxParameterRef` includes:

* `ParameterName`: string
* `IsMandatory`: bool (set-level view)
* `Position`: int?
* `TypeName`: string (optional if derivable)
* `IsSwitch`: bool

Rules:

* Syntax parameter ordering within a set is deterministic:

  1. Position ascending (null last)
  2. ParameterName ascending

---

## 7. Example Entity: `ExampleHelp`

Required fields:

* `Title`: LocalizedText (required; auto-generated if absent)
* `Code`: LocalizedText (required)
* `Remarks`: LocalizedText (optional)

Rules:

* Examples maintain original order from source.
* Code is preserved exactly (no reformatting).

---

## 8. Type Entity: `TypeHelp`

Fields:

* `TypeName`: string (e.g., `System.String`)
* `Description`: LocalizedText (optional)

Rules:

* If a source provides only type names, description remains empty.

---

## 9. Link Entity: `LinkHelp`

Fields:

* `LinkText`: LocalizedText (required)
* `Uri`: string (required)

Rules:

* No URL normalization beyond basic validation.
* Generators may omit invalid URIs (with warning).

---

## 10. Placeholder Policy

When source content is missing, the model must still be complete enough to generate valid artifacts.

Placeholder requirements:

* `Synopsis` must exist (placeholder allowed)
* Parameter `Description` must exist (placeholder allowed)
* ParameterSets must exist (at least one)

Placeholders are marked via an internal flag (e.g., `IsPlaceholder = true`) to enable:

* Warnings in validation
* Optional reporting without changing output structure

---

## 11. Determinism Policy

Before generation, the model must be normalized:

* Sort commands by name
* Sort parameters by name
* Sort parameter sets by name (default set first)
* Stabilize link ordering (by LinkText then Uri)
* Preserve example ordering

Determinism is required to enable golden fixture tests and exact diffs.

---

## Rationale

A strict normalized model:

* Reduces generator complexity
* Enables multiple input types without duplicated logic
* Makes validation and testing straightforward
* Provides a stable foundation for future localization support

---

## Consequences

Positive:

* Predictable and consistent output across sources
* Easier to evolve generators independently of parsers
* Strong contract for tests and fixtures

Trade-offs:

* Requires upfront modeling work
* Requires normalization passes and validation rules
